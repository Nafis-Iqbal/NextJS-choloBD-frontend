// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

model User {
    id               String        @id @default(uuid())
    userName         String?       @default("Guest_User")
    firstName        String?
    lastName         String?
    email            String        @unique
    phoneNumber      String?       @unique
    passwordHashed   String?
    role             Role          @default(USER)
    userStatus       UserStatus    @default(ACTIVE)
    paymentStatus    PaymentStatus @default(PAID)
    serviceTypeAdmin ServiceType? // for SERVICE_ADMIN role
    spent            Int           @default(0)
    earned           Int           @default(0)
    emailVerified    DateTime?
    phoneVerified    DateTime?
    createdAt        DateTime      @default(now())

    notifications       Notification[]
    accounts            Account[]
    paymentTransactions PaymentTransaction[]
    profileImage        Image?
    wallet              Wallet?
    reviews             Review[]
    userTripPlans       UserTripPlan[]
    adminLogs           AdminLog[]
    tripBookings        TripBooking[]
}

model Account {
    id                String  @id @default(uuid())
    userId            String
    provider          String
    providerAccountId String
    type              String
    refreshToken      String?
    accessToken       String?
    expiresAt         Int?
    idToken           String?
    scope             String?
    tokenType         String?
    sessionState      String?

    user User @relation(fields: [userId], references: [id])

    @@unique([provider, providerAccountId])
}

model Location {
    id          String  @id @default(uuid())
    name        String  @unique
    description String?

    locationType LocationType
    country      String
    state        String?
    city         String?
    latitude     Float?
    longitude    Float?

    // Hierarchy support
    parentLocationId String?
    timezone         String?
    popularityScore  Int      @default(0)
    imageUrl         String?
    features         String[] // ["beach", "mountains", "historical"]
    climate          String? // "tropical", "temperate", etc.
    bestVisitTime    String? // "October to March"

    isPopular Boolean @default(false)

    createdAt DateTime @default(now())

    // Hierarchy relations only
    parentLocation Location?  @relation("LocationHierarchy", fields: [parentLocationId], references: [id])
    childLocations Location[] @relation("LocationHierarchy")

    // Single reverse relations for entities
    tourPackages  TourPackage[]  @relation("PackageLocation")
    tourSpots     TourSpot[]     @relation("SpotLocation")
    activitySpots ActivitySpot[] @relation("ActivityLocation")
    hotels        Hotel[]        @relation("HotelLocation")
}

model TourPackage {
    id               String  @id @default(uuid())
    packageName      String
    shortDescription String?

    tourType     TourType
    duration     Int // in days
    maxGroupSize Int      @default(20)

    locationId String

    totalBudget Float
    rating      Float   @default(0)
    isActive    Boolean @default(true)
    isPopular   Boolean @default(false)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    location      Location         @relation("PackageLocation", fields: [locationId], references: [id])
    daySegments   TourDaySegment[]
    userTripPlans UserTripPlan[]
}

model TourDaySegment {
    id            String @id @default(uuid())
    tourPackageId String

    dayNumber      Int
    tourSpotId     String
    activitySpotId String?

    transportOption TransportServiceType
    hotelOption     HotelServiceType

    tourPackage  TourPackage       @relation(fields: [tourPackageId], references: [id])
    userSegments UserTripSegment[]
}

model UserTripPlan {
    id               String  @id @default(uuid())
    userId           String
    name             String
    description      String?
    basedOnPackageId String? // Optional: forked from admin package

    startDate       DateTime
    endDate         DateTime
    status          UserTripStatus @default(PLANNING)
    estimatedBudget Float?
    actualCost      Float?
    isPublic        Boolean        @default(false)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    user           User              @relation(fields: [userId], references: [id], onDelete: Cascade)
    basedOnPackage TourPackage?      @relation(fields: [basedOnPackageId], references: [id])
    userSegments   UserTripSegment[]
    tripBookings   TripBooking[]
}

model UserTripSegment {
    id             String @id @default(uuid())
    userTripPlanId String
    dayNumber      Int
    segmentOrder   Int // Order within the day (1st, 2nd, 3rd activity)

    // Can be based on existing TourDaySegment or completely custom
    basedOnSegmentId String?

    // Custom overrides (user can modify these)
    customTourSpotId     String?
    customActivitySpotId String?
    customTransport      TransportServiceType?
    customHotel          HotelServiceType?
    customNotes          String?
    estimatedCost        Float?
    startTime            String? // "09:00"
    endTime              String? // "12:00"

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    userTripPlan   UserTripPlan    @relation(fields: [userTripPlanId], references: [id], onDelete: Cascade)
    basedOnSegment TourDaySegment? @relation(fields: [basedOnSegmentId], references: [id])

    @@unique([userTripPlanId, dayNumber, segmentOrder])
}

model TourSpot {
    id          String  @id @default(uuid())
    name        String  @unique
    description String?

    locationId String
    addressId  String?

    entryCost       Float?
    openingHours    String?
    bestTimeToVisit String?
    contactInfo     Json? // Phone, email, website
    facilities      String[] // ["parking", "restroom", "cafe"]
    accessibility   String[] // ["wheelchair", "elderly_friendly"]
    seasonalInfo    Json? // Operating seasons, weather considerations

    spotType  ActivityType
    rating    Float?       @default(0)
    isPopular Boolean      @default(false)

    createdAt DateTime @default(now())

    location Location @relation("SpotLocation", fields: [locationId], references: [id])
    reviews  Review[]
    images   Image[]
}

model ActivitySpot {
    id          String  @id @default(uuid())
    name        String  @unique
    description String?

    locationId String
    addressId  String?

    maxParticipants  Int      @default(10)
    entryCost        Float
    openingHours     String? // in hours
    bestTimeToVisit  String?
    duration         String? // "2 hours", "Half day"
    difficulty       String? // "Easy", "Moderate", "Hard"
    ageRestriction   String? // "18+", "All ages"
    equipment        String[] // Required/provided equipment
    safetyGuidelines String[]

    activityType ActivityType
    rating       Float?       @default(0)
    isActive     Boolean      @default(true)
    isPopular    Boolean      @default(false)

    createdAt DateTime @default(now())

    location Location @relation("ActivityLocation", fields: [locationId], references: [id])
    reviews  Review[]
    images   Image[]
}

model Hotel {
    id          String  @id @default(uuid())
    name        String  @unique
    description String?

    locationId String
    addressId  String?

    phoneNumber       String?
    email             String?
    website           String?
    priceRange        String? // "Budget", "Mid-range", "Luxury"
    totalRooms        Int?
    availableRooms    Int?
    policies          Json? // Check-in/out policies, cancellation, etc.
    nearbyAttractions String[]

    rating    Int       @default(1) // 1-5 stars
    hotelType HotelType
    amenities String[] // ["WiFi", "Pool", "Spa", "Gym"]

    checkInTime  String? @default("14:00")
    checkOutTime String? @default("11:00")

    isActive Boolean @default(true)

    createdAt DateTime @default(now())

    location Location @relation("HotelLocation", fields: [locationId], references: [id])
    reviews  Review[]
}

model Review {
    id          String     @id @default(uuid())
    title       String?
    description String
    rating      Float
    reviewType  ReviewType
    isVerified  Boolean    @default(false)
    createdAt   DateTime   @default(now())

    userId         String
    tourSpotId     String?
    activitySpotId String?
    hotelId        String?

    // Relations
    user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
    TourSpot     TourSpot?     @relation(fields: [tourSpotId], references: [id], onDelete: Cascade)
    ActivitySpot ActivitySpot? @relation(fields: [activitySpotId], references: [id], onDelete: Cascade)
    Hotel        Hotel?        @relation(fields: [hotelId], references: [id], onDelete: Cascade)

    // Ensure one user can only review each entity once
    @@unique([tourSpotId, userId])
    @@unique([activitySpotId, userId])
    @@unique([hotelId, userId])
}

model PaymentTransaction {
    id            String      @id @default(uuid()) @map("_id")
    transactionId String      @unique // SSLCommerz transaction ID
    serviceType   ServiceType
    serviceTypeId String      @unique
    userId        String

    amount   Float         @default(0)
    currency String        @default("BDT")
    status   PaymentStatus @default(UNPAID)

    // SSLCommerz essential fields only
    val_id       String? // Validation ID from SSLCommerz
    bank_tran_id String? // Bank transaction reference

    initiatedAt DateTime  @default(now())
    completedAt DateTime?

    // Optional fields
    failureReason  String?
    sslcommerzData Json? // Raw SSLCommerz response (for debugging)

    user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)
    refunds PaymentRefund[]
    logs    PaymentLog[]

    @@map("payment_transactions")
}

model PaymentRefund {
    id                   String @id @default(uuid()) @map("_id")
    paymentTransactionId String

    amount  Float        @default(0)
    remarks String
    status  RefundStatus @default(PENDING)

    // SSLCommerz refund reference
    refund_ref_id String?

    requestedAt DateTime  @default(now())
    completedAt DateTime?

    paymentTransaction PaymentTransaction @relation(fields: [paymentTransactionId], references: [id], onDelete: Cascade)

    @@map("payment_refunds")
}

model PaymentLog {
    id                   String @id @default(uuid()) @map("_id")
    paymentTransactionId String
    event                String // e.g., "INITIATED", "SUCCESS", "FAILED", "IPN_RECEIVED"
    details              Json?

    createdAt DateTime @default(now())

    paymentTransaction PaymentTransaction @relation(fields: [paymentTransactionId], references: [id], onDelete: Cascade)

    @@index([paymentTransactionId]) // for faster queries per transaction
    @@map("payment_logs")
}

model Wallet {
    id             String       @id @default(uuid())
    userId         String       @unique
    balance        Float        @default(0)
    currency       String       @default("BDT")
    walletStatus   WalletStatus @default(ACTIVE)
    pin            String? // Encrypted wallet PIN
    lastActivityAt DateTime?
    createdAt      DateTime     @default(now())
    updatedAt      DateTime     @updatedAt

    user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
    transactions WalletTransaction[]
    refunds      WalletRefund[]
    logs         WalletLog[]

    @@map("wallets")
}

model WalletTransaction {
    id              String                @id @default(uuid())
    walletId        String
    transactionType WalletTransactionType
    amount          Float
    currency        String                @default("BDT")
    description     String?
    referenceId     String? // Reference to external transaction
    referenceType   String? // Type of reference (payment, refund, etc.)
    balanceBefore   Float
    balanceAfter    Float
    status          TransactionStatus     @default(PENDING)
    metadata        Json? // Additional transaction data
    createdAt       DateTime              @default(now())
    processedAt     DateTime?

    wallet  Wallet         @relation(fields: [walletId], references: [id], onDelete: Cascade)
    refunds WalletRefund[]
    logs    WalletLog[]

    @@index([walletId])
    @@index([status])
    @@index([transactionType])
    @@map("wallet_transactions")
}

model WalletRefund {
    id                  String       @id @default(uuid())
    walletId            String
    walletTransactionId String
    amount              Float
    currency            String       @default("BDT")
    reason              String
    refundStatus        RefundStatus @default(PENDING)
    adminNotes          String?
    requestedAt         DateTime     @default(now())
    processedAt         DateTime?
    completedAt         DateTime?

    wallet            Wallet            @relation(fields: [walletId], references: [id], onDelete: Cascade)
    walletTransaction WalletTransaction @relation(fields: [walletTransactionId], references: [id], onDelete: Cascade)

    @@index([walletId])
    @@index([refundStatus])
    @@map("wallet_refunds")
}

model WalletLog {
    id                  String   @id @default(uuid())
    walletId            String
    walletTransactionId String?
    event               String // e.g., "CREDIT", "DEBIT", "PIN_CHANGE", "LOCKED", "UNLOCKED"
    description         String?
    ipAddress           String?
    userAgent           String?
    metadata            Json?
    createdAt           DateTime @default(now())

    wallet            Wallet             @relation(fields: [walletId], references: [id], onDelete: Cascade)
    walletTransaction WalletTransaction? @relation(fields: [walletTransactionId], references: [id], onDelete: SetNull)

    @@index([walletId])
    @@index([event])
    @@map("wallet_logs")
}

model Image {
    id       String  @id @default(uuid())
    url      String
    altText  String?
    order    Int? // display priority/order
    width    Int? // pixels
    height   Int? // pixels
    fileSize Int? // bytes
    userId   String  @unique

    user           User          @relation(fields: [userId], references: [id])
    TourSpot       TourSpot?     @relation(fields: [tourSpotId], references: [id])
    tourSpotId     String?
    ActivitySpot   ActivitySpot? @relation(fields: [activitySpotId], references: [id])
    activitySpotId String?
}

model HeroSectionImage {
    id       String  @id @default(uuid())
    url      String
    altText  String?
    order    Int?
    width    Int?
    height   Int?
    fileSize Int?

    section HeroSection @default(TOP)

    siteConfigId String
    siteConfig   SiteConfig @relation(fields: [siteConfigId], references: [id])
}

model Address {
    id           String @id @default(uuid())
    addressLine1 String
    addressLine2 String
    city         String
    state        String
    postalCode   String
    country      String
    phoneNumber  String

    userId String?

    @@unique([id, userId])
}

model Notification {
    id String @id @default(uuid())

    content              String
    isRead               Boolean  @default(false)
    notificationPriority Priority @default(NORMAL)

    userId String
    user   User   @relation(fields: [userId], references: [id])

    @@unique([id, userId])
}

model SiteConfig {
    id          String     @id @default("SITE_CONFIG") // fixed ID for singleton
    isSingleton Boolean    @unique @default(true)
    siteStatus  SiteStatus @default(ACTIVE)

    updatedAt DateTime @updatedAt

    heroImages HeroSectionImage[]
}

model AdminLog {
    id         String      @id @default(uuid())
    adminId    String
    action     AdminAction
    entityType EntityType
    entityId   String
    details    Json?
    ipAddress  String?
    userAgent  String?
    createdAt  DateTime    @default(now())

    admin User @relation(fields: [adminId], references: [id], onDelete: Cascade)

    @@index([adminId])
    @@index([action])
    @@index([entityType])
    @@index([createdAt])
}

model TripBooking {
    id               String        @id @default(uuid())
    userTripPlanId   String
    userId           String
    status           BookingStatus @default(PENDING)
    totalAmount      Float
    advanceAmount    Float?
    remainingAmount  Float?
    paymentMethod    String? // "wallet", "sslcommerz", "cash"
    confirmationCode String?       @unique
    specialRequests  String?

    bookedAt     DateTime  @default(now())
    confirmeddAt DateTime?
    checkInDate  DateTime?
    checkOutDate DateTime?

    userTripPlan UserTripPlan @relation(fields: [userTripPlanId], references: [id], onDelete: Cascade)
    user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
    @@index([status])
    @@index([bookedAt])
}

enum AdminAction {
    CREATED_HOTEL
    UPDATED_HOTEL
    DELETED_HOTEL
    CREATED_TOURSPOT
    UPDATED_TOURSPOT
    DELETED_TOURSPOT
    CREATED_ACTIVITYSPOT
    UPDATED_ACTIVITYSPOT
    DELETED_ACTIVITYSPOT
    CREATED_LOCATION
    UPDATED_LOCATION
    DELETED_LOCATION
    CREATED_TOURPACKAGE
    UPDATED_TOURPACKAGE
    DELETED_TOURPACKAGE
    USER_MANAGEMENT
    PAYMENT_REFUND
    SITE_CONFIG
}

enum EntityType {
    HOTEL
    TOUR_SPOT
    ACTIVITY_SPOT
    LOCATION
    TOUR_PACKAGE
    USER
    PAYMENT
    SITE_CONFIG
}

enum BookingStatus {
    PENDING
    CONFIRMED
    CANCELLED
    COMPLETED
    REFUNDED
    NO_SHOW
}

enum UserTripStatus {
    PLANNING
    SAVED
    BOOKED
    IN_PROGRESS
    COMPLETED
    CANCELLED
}

enum UserStatus {
    ACTIVE
    BANNED
    RESTRICTED
}

enum Role {
    MASTER_ADMIN
    SERVICE_ADMIN
    EMPLOYEE
    USER
}

enum Priority {
    NORMAL
    URGENT
}

enum TourType {
    ADVENTURE
    CULTURAL
    BEACH
    CITY_TOUR
    NATURE
    RELIGIOUS
    HISTORICAL
}

enum LocationType {
    CITY
    BEACH
    MOUNTAIN
    FOREST
    DESERT
    ISLAND
    COUNTRYSIDE
}

enum HotelType {
    LUXURY
    BUDGET
    BOUTIQUE
    RESORT
    HOSTEL
    GUESTHOUSE
    APARTMENT
}

enum ActivityType {
    SIGHTSEEING
    ADVENTURE_SPORTS
    WATER_ACTIVITIES
    CULTURAL_EXPERIENCE
    FOOD_TASTING
    SHOPPING
    WILDLIFE
}

enum ServiceType {
    HOTEL_BOOKING
    TOUR_PACKAGE
    TRANSPORT_SERVICE
    ACTIVITY_BOOKING
    GUIDE_SERVICE
}

enum HotelServiceType {
    MEDIUM_RANGE
    LUXURY
    BUDGET
    SELF_MANAGED
}

enum TransportServiceType {
    BUS
    FLIGHT
    TRAIN
    CAR_RENTAL
    FERRY
    SELF_MANAGED
}

enum BusServiceType {
    AC_SLEEPER
    NON_AC_SLEEPER
    AC_SEATER
    NON_AC_SEATER
    DELUXE
    SEMI_DELUXE
    LUXURY
}

enum FlightServiceType {
    ECONOMY
    BUSINESS
    FIRST_CLASS
    PREMIUM_ECONOMY
}

enum TrainServiceType {
    AC_1_TIER
    AC_2_TIER
    AC_3_TIER
    SLEEPER
    GENERAL
    CHAIR_CAR
}

enum ReviewType {
    HOTEL
    TOUR_SPOT
    ACTIVITY_SPOT
}

enum PaymentStatus {
    UNPAID
    PAID
}

enum RefundStatus {
    PENDING
    COMPLETED
    FAILED
}

enum ComplaintStatus {
    PENDING
    UNDER_REVIEW
    UNSOLVED
    SOLVED
    CLOSED
}

enum SiteStatus {
    ACTIVE
    DOWN
}

enum HeroSection {
    TOP
    MIDDLE
    BOTTOM
}

enum WalletStatus {
    ACTIVE
    LOCKED
    SUSPENDED
    CLOSED
}

enum WalletTransactionType {
    CREDIT
    DEBIT
    TRANSFER_IN
    TRANSFER_OUT
    CASHBACK
    REFUND
    PENALTY
    BONUS
}

enum TransactionStatus {
    PENDING
    PROCESSING
    COMPLETED
    FAILED
    CANCELLED
    REVERSED
}

// =====================================
// STANDALONE MODELS (COMMENTED OUT)
// =====================================

// model Weather {
//     id           String   @id @default(uuid())
//     locationName String
//     country      String
//     temperature  Float    // in Celsius
//     humidity     Int      // percentage
//     weatherType  String   // "sunny", "rainy", "cloudy", etc.
//     windSpeed    Float?   // km/h
//     visibility   Float?   // km
//     uvIndex      Int?
//     description  String?
//     forecastDate DateTime
//     createdAt    DateTime @default(now())
//     updatedAt    DateTime @updatedAt
// 
//     @@index([locationName])
//     @@index([forecastDate])
//     @@map("weather_data")
// }

// model Currency {
//     id           String   @id @default(uuid())
//     code         String   @unique // "BDT", "USD", "EUR", etc.
//     name         String   // "Bangladeshi Taka", "US Dollar"
//     symbol       String   // "৳", "$", "€"
//     exchangeRate Float    // Rate against base currency (e.g., USD)
//     isBaseCurrency Boolean @default(false)
//     isActive     Boolean  @default(true)
//     lastUpdated  DateTime @default(now())
//     createdAt    DateTime @default(now())
// 
//     @@map("currencies")
// }

// model Visa {
//     id                  String   @id @default(uuid())
//     countryCode         String   // "BD", "IN", "US", etc.
//     countryName         String
//     visaRequired        Boolean
//     visaType            String?  // "Tourist", "Business", "Transit"
//     processingTime      String?  // "3-5 business days"
//     validityPeriod      String?  // "30 days", "6 months"
//     entryType           String?  // "Single", "Multiple"
//     fee                 Float?
//     currency            String   @default("USD")
//     requirements        String[] // ["Passport", "Photo", "Bank Statement"]
//     additionalInfo      String?
//     consulate           String?
//     website             String?
//     isActive            Boolean  @default(true)
//     createdAt           DateTime @default(now())
//     updatedAt           DateTime @updatedAt
// 
//     @@index([countryCode])
//     @@map("visa_requirements")
// }

// model Discount {
//     id            String      @id @default(uuid())
//     code          String      @unique
//     name          String
//     description   String?
//     discountType  DiscountType
//     value         Float       // Percentage or fixed amount
//     currency      String      @default("BDT")
//     minAmount     Float?      // Minimum order amount
//     maxDiscount   Float?      // Maximum discount cap
//     usageLimit    Int?        // Total usage limit
//     usedCount     Int         @default(0)
//     userLimit     Int?        // Per user limit
//     validFrom     DateTime
//     validTo       DateTime
//     isActive      Boolean     @default(true)
//     applicableFor String[]    // ["tour_package", "hotel", "activity"]
//     createdAt     DateTime    @default(now())
//     updatedAt     DateTime    @updatedAt
// 
//     @@index([code])
//     @@index([validFrom, validTo])
//     @@map("discounts")
// }

// model Emergency {
//     id            String   @id @default(uuid())
//     contactType   String   // "Police", "Hospital", "Embassy", "Tourist Helpline"
//     name          String
//     phoneNumber   String
//     email         String?
//     address       String?
//     city          String
//     country       String
//     coordinates   String?  // "lat,lng"
//     availability  String?  // "24/7", "9 AM - 5 PM"
//     language      String[] // ["English", "Bengali", "Hindi"]
//     description   String?
//     isActive      Boolean  @default(true)
//     priority      Int      @default(1) // 1=highest, 5=lowest
//     createdAt     DateTime @default(now())
//     updatedAt     DateTime @updatedAt
// 
//     @@index([city, country])
//     @@index([contactType])
//     @@map("emergency_contacts")
// }

// model Gallery {
//     id          String      @id @default(uuid())
//     title       String
//     description String?
//     imageUrl    String
//     altText     String?
//     category    String      // "destination", "activity", "hotel", "culture"
//     tags        String[]    // ["beach", "sunset", "coxsbazar"]
//     location    String?
//     photographer String?
//     isPublic    Boolean     @default(true)
//     isFeatured  Boolean     @default(false)
//     viewCount   Int         @default(0)
//     likes       Int         @default(0)
//     fileSize    Int?        // in bytes
//     dimensions  String?     // "1920x1080"
//     createdAt   DateTime    @default(now())
//     updatedAt   DateTime    @updatedAt
// 
//     @@index([category])
//     @@index([isPublic, isFeatured])
//     @@map("gallery_images")
// }

// enum DiscountType {
//     PERCENTAGE
//     FIXED_AMOUNT
//     BUY_ONE_GET_ONE
//     FREE_SHIPPING
// }
